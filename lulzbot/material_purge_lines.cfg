[gcode_macro M8100]
gcode:
    {% set MATERIAL_DIAMETER = params.D|default(1.75)|float %}
    {% set NOZZLE_SIZE = params.N|default(0.5)|float %}
    {% set MATERIAL_TYPE = params.M|default(1)|int %}
    {% set SPEED = (NOZZLE_SIZE * 2 *1800) %}

    G91
    G0 F{SPEED} # Set the speed as a factor of the Nozzle Size

    {% if MATERIAL_DIAMETER == 1.75 %} # check the matirial diameter and adjust the flowrate
        M221 S100
    {% else %}
        M221 S37.7
    {% endif %}

    {% if MATERIAL_TYPE == 1 %} # Generic purge
        M117 Purging...
        G1 Y100 E12
    {% elif MATERIAL_TYPE == 2 %} # ABS
        M117 Purging ABS...
        G1 Y10 E1.7
        G1 Y10 X10 E1.7
        G1 Y10 E1.7
        G1 Y10 X-10 E1.7
        G1 Y10 E1.7
        G1 Y10 X10 E1.7
        G1 Y10 E1.7
        G1 Y10 X-10 E1.7
        G1 Y10 E1.7
        G1 Y10 X10 E1.7
    {% elif MATERIAL_TYPE == 3 %} # TPU
        M117 Purging TPU...
        G1 X10 Y10 E1.7
        G1 X-10 Y10 E1.7
        G1 X10 Y10 E1.7
        G1 X-10 Y10 E1.7
        G1 X10 Y10 E1.7
        G1 X-10 Y10 E1.7
        G1 X10 Y10 E1.7
        G1 X-10 Y10 E1.7
        G1 X10 Y10 E1.7
    {% elif MATERIAL_TYPE == 4 %} # PETg
        M117 Purging PETg...
        G1 Y10 E1.1
        G1 Y20 X10 E2.2
        G1X-10 E1.1
        G1 Y20 X10 E2.2
        G1X-10 E1.1
        G1 Y20 X10 E2.2
        G1X-10 E1.1
        G1 Y20 X10 E2.2
    {% elif MATERIAL_TYPE == 5 %} # PLA
        M117 Purging PLA...
        G1 Y10 E0.85
        G1 X10 E0.85
        G1 Y10 E0.85
        G1 X-10 E0.85
        G1 Y10 E0.85
        G1 X10 E0.85
        G1 Y10 E0.85
        G1 X-10 E0.85
        G1 Y10 E0.85
        G1 X10 E0.85
        G1 Y10 E0.85
        G1 X-10 E0.85
        G1 Y10 E0.85
        G1 X10 E0.85
        G1 Y10 E0.85
        G1 X-10 E0.85
        G1 Y10 E0.85
        G1 X10 E0.85
        G1 Y10 E0.85
    {% endif %}
    G90
    M221 S100 # Reset Extrude factor back to 100%
